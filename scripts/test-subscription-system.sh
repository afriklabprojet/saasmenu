#!/bin/bash

# Script de test manuel pour le syst√®me d'abonnement
# RestroSaaS - Tests Fonctionnels

echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë                                                                   ‚ïë"
echo "‚ïë          üß™ SCRIPT DE TESTS FONCTIONNELS - RESTRO SAAS            ‚ïë"
echo "‚ïë                                                                   ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""

# Couleurs
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Compteurs
TESTS_PASSED=0
TESTS_FAILED=0
TESTS_TOTAL=0

# Fonction pour afficher un test
test_header() {
    echo ""
    echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${BLUE}üß™ TEST $1: $2${NC}"
    echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
}

# Fonction pour marquer un test r√©ussi
test_pass() {
    echo -e "${GREEN}‚úÖ $1${NC}"
    ((TESTS_PASSED++))
    ((TESTS_TOTAL++))
}

# Fonction pour marquer un test √©chou√©
test_fail() {
    echo -e "${RED}‚ùå $1${NC}"
    ((TESTS_FAILED++))
    ((TESTS_TOTAL++))
}

# Fonction pour afficher un warning
test_warn() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

# V√©rifier que nous sommes dans le bon r√©pertoire
if [ ! -f "artisan" ]; then
    echo -e "${RED}‚ùå Erreur: Ce script doit √™tre ex√©cut√© depuis le r√©pertoire racine de Laravel${NC}"
    exit 1
fi

echo "üìÅ R√©pertoire de travail: $(pwd)"
echo ""

# ============================================================================
# TEST 1: V√©rification de l'environnement
# ============================================================================
test_header "1" "V√©rification de l'environnement"

# V√©rifier PHP
if command -v php &> /dev/null; then
    PHP_VERSION=$(php -v | head -n 1)
    test_pass "PHP install√©: $PHP_VERSION"
else
    test_fail "PHP n'est pas install√©"
fi

# V√©rifier Laravel
if php artisan --version &> /dev/null; then
    LARAVEL_VERSION=$(php artisan --version)
    test_pass "Laravel: $LARAVEL_VERSION"
else
    test_fail "Erreur Laravel"
fi

# V√©rifier la connexion DB
if php artisan db:show &> /dev/null; then
    test_pass "Connexion base de donn√©es OK"
else
    test_warn "Impossible de v√©rifier la connexion DB"
fi

# ============================================================================
# TEST 2: V√©rification des migrations
# ============================================================================
test_header "2" "V√©rification des migrations"

# V√©rifier que la migration des limites existe
if php artisan migrate:status | grep -q "add_limits_to_pricing_plans"; then
    test_pass "Migration 'add_limits_to_pricing_plans' trouv√©e"
else
    test_fail "Migration 'add_limits_to_pricing_plans' manquante"
fi

# V√©rifier l'√©tat des migrations
PENDING=$(php artisan migrate:status | grep -c "Pending")
if [ "$PENDING" -eq 0 ]; then
    test_pass "Toutes les migrations sont ex√©cut√©es"
else
    test_warn "$PENDING migration(s) en attente"
fi

# ============================================================================
# TEST 3: V√©rification de la structure de la base de donn√©es
# ============================================================================
test_header "3" "Structure de la base de donn√©es"

echo "V√©rification des colonnes dans pricing_plans..."

# Test via tinker
TINKER_SCRIPT="
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

\$columns = Schema::getColumnListing('pricing_plans');
\$required = ['products_limit', 'categories_limit', 'staff_limit', 'whatsapp_integration', 'analytics'];

\$missing = [];
foreach (\$required as \$col) {
    if (!in_array(\$col, \$columns)) {
        \$missing[] = \$col;
    }
}

if (empty(\$missing)) {
    echo 'ALL_OK';
} else {
    echo 'MISSING:' . implode(',', \$missing);
}
"

RESULT=$(echo "$TINKER_SCRIPT" | php artisan tinker 2>/dev/null | grep -E "ALL_OK|MISSING" | tail -1)

if [[ "$RESULT" == *"ALL_OK"* ]]; then
    test_pass "Toutes les colonnes requises sont pr√©sentes"
else
    test_fail "Colonnes manquantes: ${RESULT#MISSING:}"
fi

# ============================================================================
# TEST 4: V√©rification des contr√¥leurs
# ============================================================================
test_header "4" "V√©rification des contr√¥leurs"

# V√©rifier PlanPricingController
if grep -q "products_limit" app/Http/Controllers/Admin/PlanPricingController.php; then
    test_pass "PlanPricingController contient 'products_limit'"
else
    test_fail "PlanPricingController ne contient pas 'products_limit'"
fi

if grep -q "categories_limit" app/Http/Controllers/Admin/PlanPricingController.php; then
    test_pass "PlanPricingController contient 'categories_limit'"
else
    test_fail "PlanPricingController ne contient pas 'categories_limit'"
fi

# V√©rifier ProductController
if grep -q "getPlanInfo" app/Http/Controllers/Admin/ProductController.php; then
    test_pass "ProductController utilise getPlanInfo()"
else
    test_fail "ProductController n'utilise pas getPlanInfo()"
fi

# V√©rifier CategoryController
if grep -q "getPlanInfo" app/Http/Controllers/Admin/CategoryController.php; then
    test_pass "CategoryController utilise getPlanInfo()"
else
    test_fail "CategoryController n'utilise pas getPlanInfo()"
fi

# ============================================================================
# TEST 5: V√©rification du helper
# ============================================================================
test_header "5" "V√©rification du helper getPlanInfo()"

if grep -q "function getPlanInfo" app/Helpers/helper.php; then
    test_pass "Fonction getPlanInfo() existe"

    # V√©rifier qu'elle retourne un tableau
    if grep -A 20 "function getPlanInfo" app/Helpers/helper.php | grep -q "return \["; then
        test_pass "getPlanInfo() retourne un tableau"
    else
        test_warn "getPlanInfo() pourrait ne pas retourner un tableau"
    fi
else
    test_fail "Fonction getPlanInfo() manquante"
fi

# ============================================================================
# TEST 6: V√©rification des templates
# ============================================================================
test_header "6" "V√©rification des templates Blade"

# product.blade.php
if [ -f "resources/views/admin/product/product.blade.php" ]; then
    if grep -q "getPlanInfo" resources/views/admin/product/product.blade.php; then
        test_pass "product.blade.php contient l'indicateur de limite"
    else
        test_fail "product.blade.php ne contient pas l'indicateur"
    fi
else
    test_fail "product.blade.php n'existe pas"
fi

# category.blade.php
if [ -f "resources/views/admin/category/category.blade.php" ]; then
    if grep -q "getPlanInfo" resources/views/admin/category/category.blade.php; then
        test_pass "category.blade.php contient l'indicateur de limite"
    else
        test_fail "category.blade.php ne contient pas l'indicateur"
    fi
else
    test_fail "category.blade.php n'existe pas"
fi

# add_plan.blade.php
if [ -f "resources/views/admin/plan/add_plan.blade.php" ]; then
    if grep -q "products_limit" resources/views/admin/plan/add_plan.blade.php; then
        test_pass "add_plan.blade.php contient les nouveaux champs"
    else
        test_fail "add_plan.blade.php ne contient pas les nouveaux champs"
    fi
else
    test_fail "add_plan.blade.php n'existe pas"
fi

# ============================================================================
# TEST 7: V√©rification des traductions
# ============================================================================
test_header "7" "V√©rification des traductions fran√ßaises"

if [ -f "resources/lang/fr/labels.php" ]; then
    if grep -q "product_limit_reached" resources/lang/fr/labels.php; then
        test_pass "Traduction 'product_limit_reached' existe"
    else
        test_fail "Traduction 'product_limit_reached' manquante"
    fi

    if grep -q "category_limit_reached" resources/lang/fr/labels.php; then
        test_pass "Traduction 'category_limit_reached' existe"
    else
        test_fail "Traduction 'category_limit_reached' manquante"
    fi

    if grep -q "upgrade_to_add_more" resources/lang/fr/labels.php; then
        test_pass "Traduction 'upgrade_to_add_more' existe"
    else
        test_fail "Traduction 'upgrade_to_add_more' manquante"
    fi
else
    test_fail "Fichier de traduction FR n'existe pas"
fi

# ============================================================================
# TEST 8: V√©rification des routes
# ============================================================================
test_header "8" "V√©rification des routes"

if php artisan route:list | grep -q "products/add"; then
    test_pass "Route 'products/add' existe"
else
    test_fail "Route 'products/add' manquante"
fi

if php artisan route:list | grep -q "categories/add"; then
    test_pass "Route 'categories/add' existe"
else
    test_fail "Route 'categories/add' manquante"
fi

if php artisan route:list | grep -q "plan/save_plan"; then
    test_pass "Route 'plan/save_plan' existe"
else
    test_fail "Route 'plan/save_plan' manquante"
fi

# ============================================================================
# TEST 9: V√©rification des caches
# ============================================================================
test_header "9" "√âtat des caches"

echo "V√©rification des fichiers de cache..."

if [ -d "bootstrap/cache" ] && [ "$(ls -A bootstrap/cache)" ]; then
    test_warn "Des fichiers de cache existent dans bootstrap/cache"
    echo "   üí° Recommandation: Ex√©cutez 'php artisan optimize:clear'"
else
    test_pass "Pas de cache dans bootstrap/cache"
fi

if [ -d "storage/framework/cache" ] && [ "$(ls -A storage/framework/cache/data 2>/dev/null)" ]; then
    test_warn "Des fichiers de cache existent dans storage/framework/cache"
else
    test_pass "Pas de cache dans storage/framework/cache"
fi

# ============================================================================
# TEST 10: Test des donn√©es
# ============================================================================
test_header "10" "V√©rification des donn√©es des plans"

PLAN_CHECK="
use App\Models\PricingPlan;

\$free = PricingPlan::where('price', 0)->first();
if (\$free && \$free->products_limit == 5 && \$free->categories_limit == 1) {
    echo 'FREE_OK';
} else {
    echo 'FREE_ERROR';
}

\$enterprise = PricingPlan::where('products_limit', -1)->first();
if (\$enterprise) {
    echo '|ENTERPRISE_OK';
} else {
    echo '|ENTERPRISE_ERROR';
}
"

RESULT=$(echo "$PLAN_CHECK" | php artisan tinker 2>/dev/null | grep -E "FREE_OK|FREE_ERROR|ENTERPRISE" | tail -1)

if [[ "$RESULT" == *"FREE_OK"* ]]; then
    test_pass "Plan Gratuit configur√© correctement (5 produits, 1 cat√©gorie)"
else
    test_fail "Plan Gratuit mal configur√©"
fi

if [[ "$RESULT" == *"ENTERPRISE_OK"* ]]; then
    test_pass "Plan Enterprise illimit√© existe"
else
    test_warn "Aucun plan illimit√© trouv√©"
fi

# ============================================================================
# R√âSUM√â FINAL
# ============================================================================
echo ""
echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë                                                                   ‚ïë"
echo "‚ïë                     üìä R√âSUM√â DES TESTS                            ‚ïë"
echo "‚ïë                                                                   ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""

echo -e "${BLUE}Tests totaux:${NC}     $TESTS_TOTAL"
echo -e "${GREEN}Tests r√©ussis:${NC}    $TESTS_PASSED"
echo -e "${RED}Tests √©chou√©s:${NC}    $TESTS_FAILED"

if [ $TESTS_FAILED -eq 0 ]; then
    echo ""
    echo -e "${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${GREEN}‚ïë                                                                   ‚ïë${NC}"
    echo -e "${GREEN}‚ïë          ‚úÖ TOUS LES TESTS SONT PASS√âS AVEC SUCC√àS                ‚ïë${NC}"
    echo -e "${GREEN}‚ïë                                                                   ‚ïë${NC}"
    echo -e "${GREEN}‚ïë     üöÄ Le syst√®me est pr√™t pour les tests manuels                 ‚ïë${NC}"
    echo -e "${GREEN}‚ïë                                                                   ‚ïë${NC}"
    echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    exit 0
else
    SUCCESS_RATE=$((TESTS_PASSED * 100 / TESTS_TOTAL))
    echo ""
    echo -e "${YELLOW}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${YELLOW}‚ïë                                                                   ‚ïë${NC}"
    echo -e "${YELLOW}‚ïë        ‚ö†Ô∏è  CERTAINS TESTS ONT √âCHOU√â ($SUCCESS_RATE% r√©ussis)              ‚ïë${NC}"
    echo -e "${YELLOW}‚ïë                                                                   ‚ïë${NC}"
    echo -e "${YELLOW}‚ïë     Consultez les d√©tails ci-dessus pour corriger les erreurs    ‚ïë${NC}"
    echo -e "${YELLOW}‚ïë                                                                   ‚ïë${NC}"
    echo -e "${YELLOW}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    exit 1
fi
